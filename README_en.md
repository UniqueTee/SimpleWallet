# SimpleWallet protocol document

Version: 1.1

Last updated: 2021.9.3

## Introduction

SimpleWallet is a universal protocol for connecting native blockchain game mobile app to MathWallet.

This protocol aims to reduce the development and adaption work of all parties through a low-coupling implementation of a wallet that helps to authorize login and payment of mobile dapp.

## SDK & Demo

iOS SDK
https://github.com/mathwallet/MathWalletSDK-iOS

Android SDK
https://github.com/mathwallet/MathWalletSDK-Android

## Function list

- Login

Scenario: The Mobile App requests login authorization to the Wallet App.

- Payment

Scenario: The Mobile App requests payment authorization (Mobile DApp)

## Flow of the Protocol

### 1. The Wallet App registers the intercept protocol in the system

MathWallet App first registers the intercept protocol (URL Scheme, appLink) in the Operating System (OS) such that the App of dapp can pull up the wallet application. This is located at: mathwallet://mathwallet.org

Following which, the mobile terminal application of dapp calls this protocol and transfer data to the wallet App. The request format of data transfer is structured as:
mathwallet://mathwallet.org?param={the json data}

### 2. Login

#### Scenario: The mobile App of dapp pulls up the wallet App and requests the login authorization

Suitable for dapp mobile (iOS or Android) access. Business flow chart is as follows:

- The mobile terminal of dapp pulls up the wallet App, which requires the login authorization, and transfers the following data to the wallet App in json format:
```
// the data package structure transfered by dapp to wallet APP

{
protocol string // protocol name, wallet is used to distinguish different protocols, and this protocol is SimpleWallet
version string // protocol version information (ex:1.1)
blockchain string    // blockchain name (ex:ethereum). Blockchain name table: https://github.com/mathwallet/SimpleWallet
dappName string // dapp name for display in the wallet APP
dappIcon string // dapp icon Url for display in the wallet APP
action string // is assigned to login
uuID string // generated by dapp, used to verify the unique identity of dapp login
loginUrl string // dapp server generated to accept the URL for this login verification
loginMemo string // Note information for login, wallet for presentation, optional
callback string // after the user completes the operation, the wallet callback pulls up the callback URL of the dapp mobile terminal, such as appABC://abc.com?action=login, optional
              // wallet callback with this URL followed by an action (&result) such as appABC://abc.com?action=login&result=1,
        // The value of result is: 0 for user cancel, 1 for success and 2 for failure
}
```
- Dapp server receives the data, verifies the sign data, and returns success == true or false; If the validation is successful, the user is set to logged-in in the business logic of the dapp

### 3. Payment

#### Scenario: The mobile end of dapp pulls up the wallet App and requests payment authorization

Business flow chart is as follows:

![](http://qiniu.eth.fm/2021-09-03-flow.jpg)


The data package structure transfered by dapp to wallet APP
```
{
protocol   string   // procotol name, wallet used to distinguish different protocols, this protocol is SimpleWallet
version     string   // Protocol version information (ex:1.1)
blockchain string    // blockchain name (ex:ethereum). Blockchain name table: https://github.com/mathwallet/SimpleWallet
action     string   // The assignment is transfer when are paying
dappName   string   // dapp name, for display in wallet APP, optional
dappIcon   string   // dapp Logo Url，for display in wallet APP, optional
from       string   // Address of payer, optional
to         string   // Address of recipient, required
amount     number   // The amount of transfers，required
contract   string   // The token of the transfer belongs to the contract account name
symbol     string   // The token name of the transfer，required
precision   number   // The token precision of the transfer, the number of digits after the decimal point，required
dappData   string   // The business parameter information generated by dapp needs to be attached to the memo when transferring, optional

desc   string   // Transaction information, wallet displayed in the payment UI to the user, up to 128 bytes long, optional

      callback   string   // After the user completes the operation, the wallet pulls up the callback URL of the dapp mobile terminal, such as appABC://abc.com?action=login, optional

              // Add operation results (result、 txID) after this URL when wallet callback, such as: appABC://abc.com?action=login&result=1&txID=xxx,

    // The value of result is: 0 for user cancellation, 1 for success, 2 for failure. TxID is the id of this transaction on the blockchain (if any).

}
```
- The wallet assembles the above data and generates an transaction. After the user authorizes the transfer, the user submits the transfer data to the blockchain; If there is callback, pulls the dapp application
- The Dapp will either check this transaction from the mainnet according to the txID in callback (it cannot completely rely on this method to confirm the user's payment); or the dapp will set up the node to monitor the blockchain by itself, and check whether the tokens are received

### 4. Transaction

#### Scenario: The mobile end of dapp pulls up the wallet App and sign the smartcontract transaction

For Ethereum (EVM blockchain) the method is same as Payment. You just need to put the transaction data in the 'dappData' string field.

### 5. Sign a message

#### Scenario: The mobile end of dapp pulls up the wallet App and sign a specific message for validation

The data package structure transfered by dapp to wallet APP
```
{
protocol   string   // procotol name, wallet used to distinguish different protocols, this protocol is SimpleWallet
version     string   // Protocol version information (ex:1.1)
blockchain string    // blockchain name (ex:ethereum). Blockchain name table: https://github.com/mathwallet/SimpleWallet
action     string   // The assignment is signMessage
dappName   string   // dapp name, for display in wallet APP, optional
dappIcon   string   // dapp Logo Url，for display in wallet APP, optional
desc   string   // Transaction information, wallet displayed in the payment UI to the user, up to 128 bytes long, optional
	message     string   // message to sign
	isHash       bool     // Is sha256 hash?
      callback   string   // After the user completes the operation, the wallet pulls up the callback URL of the dapp mobile terminal, such as appABC://abc.com?action=signMessage, optional

              // Add operation results after this URL when wallet callback, such as: appABC://abc.com?action=signMessage&result=1&account=xxx&pubKey=xxx&signedMessage=xxx,

    // The value of result is: 0 for user cancellation, 1 for success, 2 for failure, signedMessage is the signed data.

}
```

### 6. Open Dapp URL

#### Scenario: The mobile end of dapp pulls up the wallet App and open URL inside the wallet in-app browser

The data package structure transfered by dapp to wallet APP
```
{
protocol   string   // procotol name, wallet used to distinguish different protocols, this protocol is SimpleWallet
version     string   // Protocol version information (ex:1.1)
blockchain string    // blockchain name (ex:ethereum). Blockchain name table: https://github.com/mathwallet/SimpleWallet
action     string   // The assignment is openUrl
dappName   string   // dapp name, for display in wallet APP, optional
dappIcon   string   // dapp Logo Url，for display in wallet APP, optional
desc   string   // Transaction information, wallet displayed in the payment UI to the user, up to 128 bytes long, optional
	dappUrl     string   // The URL to open
      callback   string   // After the user completes the operation, the wallet pulls up the callback URL of the dapp mobile terminal, such as appABC://abc.com?action=openUrl, optional

              // Add operation results after this URL when wallet callback, such as: appABC://abc.com?action=openUrl&result=0,

    // The value of result is: 0 for user cancellation, 2 for failure, success will not callback.

}
```

## Error Handling

### Login, payment and sign error handling

The code does not equal 0, and the request fails
```
// error return
{
  code number // error, equal to 0 is successful, greater than 0 means the request failed, dapp returns the specific error code
  error string //prompt message returned
}
```

### Open Dapp URL error handling

The result does not equal 1, and the request fails
```
// error return
{
  errorMesssge string //prompt message returned
}
```
